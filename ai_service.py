# ai_service.py

import os
import json
import time
from newspaper import Article
from openai import OpenAI

# Config í´ë˜ìŠ¤ëŠ” news_collector.py ëŒ€ì‹  ì—¬ê¸°ì„œ ë°”ë¡œ ì„í¬íŠ¸
from config import Config 

class AIService:

    def __init__(self, config: Config):
        self.config = config
        self.client = OpenAI(api_key=config.OPENAI_API_KEY)
        self.model = config.GPT_MODEL
        self.retry_limit = 3 # ìµœëŒ€ ì¬ì‹œë„ íšŸìˆ˜
        self.retry_delay = 5 # ì¬ì‹œë„ ê°„ ì§€ì—° ì‹œê°„ (ì´ˆ)


    def generate_zodiac_horoscopes(self):
        """12ê°„ì§€ ë ë³„ ìš´ì„¸ë¥¼ 'ë¡œë””' í˜ë¥´ì†Œë‚˜ë¡œ ìƒì„±í•˜ì—¬ ë¦¬ìŠ¤íŠ¸ë¡œ ë°˜í™˜í•©ë‹ˆë‹¤."""
        print("-> AI ë ë³„ ìš´ì„¸ ìƒì„±ì„ ì‹œì‘í•©ë‹ˆë‹¤... (í˜ë¥´ì†Œë‚˜: ë¡œë””)")
        zodiacs = ['ì¥', 'ì†Œ', 'í˜¸ë‘ì´', 'í† ë¼', 'ìš©', 'ë±€', 'ë§', 'ì–‘', 'ì›ìˆ­ì´', 'ë‹­', 'ê°œ', 'ë¼ì§€']
        horoscopes = []

        system_prompt = "ë„ˆëŠ” 'ë¡œë””'ë¼ëŠ” ì´ë¦„ì˜, ê¸ì • ì†Œì‹ì„ ì „í•´ì£¼ëŠ” 20ëŒ€ ì—¬ì„± ìºë¦­í„°ì•¼. ì˜¤ëŠ˜ì€ íŠ¹ë³„íˆ êµ¬ë…ìë“¤ì„ ìœ„í•´ 12ê°„ì§€ ë ë³„ ìš´ì„¸ë¥¼ ë´ì£¼ëŠ” í˜„ëª…í•œ ì¡°ì–¸ê°€ ì—­í• ì´ì•¼. '~í–ˆì–´ìš”', '~ëë‹ˆë‹¤' ê°™ì€ ê·€ì—½ê³  ìƒëƒ¥í•œ ë§íˆ¬ëŠ” ìœ ì§€í•˜ë˜, ë‹¨ìˆœí•œ ê¸ì • ë©”ì‹œì§€ê°€ ì•„ë‹Œ ê¹Šì´ ìˆëŠ” ìš´ì„¸ë¥¼ ì „ë‹¬í•´ì•¼ í•´. ì‘ë‹µì€ ë°˜ë“œì‹œ JSON í˜•ì‹ìœ¼ë¡œë§Œ ë¶€íƒí•´!"
        
        for zodiac_name in zodiacs:
            user_prompt = f"""
            ì˜¤ëŠ˜ ë‚ ì§œì— ë§ì¶° '{zodiac_name}'ë  ìš´ì„¸ ì •ë³´ë¥¼ ìƒì„±í•´ ì¤˜.

            [ì‘ì—… ì§€ì‹œ]
            1.  **ì˜¤ëŠ˜ì˜ ìš´ì„¸ (fortune)**:
                - **ì¬ë¬¼, ì§ì—…, ê´€ê³„, ê±´ê°• ë“±ì„ ì¢…í•©í•˜ì—¬, ê°€ì¥ ì¤‘ìš”í•œ í•µì‹¬ë§Œ ë‹´ì•„ ë”± í•œ ë¬¸ì¥ìœ¼ë¡œ ê°„ê²°í•˜ê²Œ ìš”ì•½í•´ ì¤˜.**                       
                - ê¸ì •ì ì¸ ì¡°ì–¸ì´ë‚˜ ì£¼ì˜ì ì„ ì§§ê²Œ í¬í•¨ì‹œì¼œ ì¤˜.     

            [ì¤‘ìš” ê·œì¹™]                                                                                                                                                      â”‚
            - ëª¨ë“  ë‹µë³€ì€ ìµœëŒ€í•œ ì§§ê³  ê°„ê²°í•´ì•¼ í•´.                                                                                                                           â”‚
            - ë‚´ìš©ì€ ë‹¤ë¥¸ ë ì™€ ê²¹ì¹˜ì§€ ì•Šê²Œ ì°½ì˜ì ìœ¼ë¡œ ë§Œë“¤ì–´ ì¤˜.  
            [ì¶œë ¥ í˜•ì‹]
            - ë°˜ë“œì‹œ ì•„ë˜ì™€ ê°™ì€ í‚¤ë¥¼ ê°€ì§„ JSON ê°ì²´ë¡œë§Œ ì‘ë‹µí•´ì•¼ í•´.
            - ì˜ˆì‹œ: {{"fortune": "..."}}
            """
            
            print(f"  -> '{zodiac_name}'ë  ìš´ì„¸ ìš”ì²­ ì¤‘...")
            response_text = self._generate_content_with_retry(system_prompt, user_prompt, is_json=True)
            
            if response_text:
                try:
                    horoscope_data = json.loads(response_text)
                    horoscope_data['name'] = zodiac_name # ë”•ì…”ë„ˆë¦¬ì— ë  ì´ë¦„ ì¶”ê°€
                    horoscopes.append(horoscope_data)
                except (json.JSONDecodeError, KeyError) as e:
                    print(f"  âŒ '{zodiac_name}'ë  ìš´ì„¸ íŒŒì‹± ì‹¤íŒ¨: {e}. í•´ë‹¹ ë ëŠ” ì œì™¸ë©ë‹ˆë‹¤.")
            else:
                print(f"  âŒ '{zodiac_name}'ë  ìš´ì„¸ ìƒì„± ì‹¤íŒ¨. API ì‘ë‹µ ì—†ìŒ.")

        if horoscopes:
            print("âœ… AI ë ë³„ ìš´ì„¸ ìƒì„± ì™„ë£Œ!")
        return horoscopes
    

    
    def generate_single_summary(self, article_title: str, article_link: str, article_text_from_selenium: str) -> str | None:
        """
        ê¸°ì‚¬ ìš”ì•½ì„ ìƒì„±í•©ë‹ˆë‹¤.
        1. newspaper3kë¡œ 1ì°¨ ì‹œë„ (íƒ€ì„ì•„ì›ƒ ì„¤ì •)
        2. ì‹¤íŒ¨ ì‹œ, Seleniumìœ¼ë¡œ ë¯¸ë¦¬ ì¶”ì¶œí•œ ë³¸ë¬¸ì„ ì‚¬ìš©í•˜ì—¬ 2ì°¨ ì‹œë„
        """
        summary = None
        try:
            # âœ¨ [í•µì‹¬ ê°œì„ ] newspaper3kì— íƒ€ì„ì•„ì›ƒê³¼ ìºì‹œ ë¹„í™œì„±í™” ì˜µì…˜ì„ ì¶”ê°€í•˜ì—¬ ì•ˆì •ì„± í™•ë³´
            article_config = {
                'memoize_articles': False,  # ìºì‹œ ì‚¬ìš© ì•ˆ í•¨
                'fetch_images': False,      # ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ ì•ˆ í•¨
                'request_timeout': 10       # ëª¨ë“  ìš”ì²­ì— 10ì´ˆ íƒ€ì„ì•„ì›ƒ ì ìš©
            }
            article = Article(article_link, config=article_config)
            article.download()
            article.parse()
            
            if len(article.text) > 100:
                system_prompt = "ë‹¹ì‹ ì€ í•µì‹¬ë§Œ ê°„ê²°í•˜ê²Œ ì „ë‹¬í•˜ëŠ” ë‰´ìŠ¤ ì—ë””í„°ì…ë‹ˆë‹¤. ëª¨ë“  ë‹µë³€ì€ í•œêµ­ì–´ë¡œ í•´ì•¼ í•©ë‹ˆë‹¤."
                user_prompt = f"ì•„ë˜ ì œëª©ê³¼ ë³¸ë¬¸ì„ ê°€ì§„ ë‰´ìŠ¤ ê¸°ì‚¬ì˜ ë‚´ìš©ì„ ë…ìë“¤ì´ ì´í•´í•˜ê¸° ì‰½ê²Œ 3ì¤„ë¡œ ìš”ì•½í•´ì£¼ì„¸ìš”.\n\n[ì œëª©]: {article_title}\n[ë³¸ë¬¸]:\n{article.text[:2000]}"
                summary = self._generate_content_with_retry(system_prompt, user_prompt)

        except Exception as e:
            print(f" Â ã„´> â„¹ï¸ newspaper3k ì²˜ë¦¬ ì‹¤íŒ¨ (2ì°¨ ì‹œë„ ì§„í–‰): {e.__class__.__name__}")
            summary = None # ì‹¤íŒ¨ ì‹œ summaryë¥¼ Noneìœ¼ë¡œ ì´ˆê¸°í™”

        # 2ì°¨ ì‹œë„: newspaper3kê°€ ì‹¤íŒ¨í–ˆê±°ë‚˜, ìš”ì•½ì„ ìƒì„±í•˜ì§€ ëª»í–ˆì„ ê²½ìš°
        if not summary or "ìš”ì•½ ì •ë³´ë¥¼ ìƒì„±í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤" in summary:
            print(" Â ã„´> â„¹ï¸ 1ì°¨ ìš”ì•½ ì‹¤íŒ¨. Selenium ì¶”ì¶œ ë³¸ë¬¸ìœ¼ë¡œ 2ì°¨ ìš”ì•½ ì‹œë„...")
            try:
                system_prompt = "ë‹¹ì‹ ì€ í•µì‹¬ë§Œ ê°„ê²°í•˜ê²Œ ì „ë‹¬í•˜ëŠ” ë‰´ìŠ¤ ì—ë””í„°ì…ë‹ˆë‹¤. ëª¨ë“  ë‹µë³€ì€ í•œêµ­ì–´ë¡œ í•´ì•¼ í•©ë‹ˆë‹¤."
                user_prompt = f"ì•„ë˜ ì œëª©ê³¼ ë³¸ë¬¸ì„ ê°€ì§„ ë‰´ìŠ¤ ê¸°ì‚¬ì˜ ë‚´ìš©ì„ ë…ìë“¤ì´ ì´í•´í•˜ê¸° ì‰½ê²Œ 3ì¤„ë¡œ ìš”ì•½í•´ì£¼ì„¸ìš”.\n\n[ì œëª©]: {article_title}\n[ë³¸ë¬¸]:\n{article_text_from_selenium[:2000]}"
                summary = self._generate_content_with_retry(system_prompt, user_prompt)
            except Exception as e:
                 print(f" Â ã„´> âŒ 2ì°¨ AI ìš”ì•½ ìƒì„± ì‹¤íŒ¨: {e.__class__.__name__}")
                 return None
        
        return summary

    def _generate_content_with_retry(self, system_prompt: str, user_prompt: str, is_json: bool = False):
        """
        OpenAI APIë¥¼ í˜¸ì¶œí•˜ì—¬ ì½˜í…ì¸ ë¥¼ ìƒì„±í•©ë‹ˆë‹¤. ì‹¤íŒ¨ ì‹œ ì¬ì‹œë„í•©ë‹ˆë‹¤.
        - system_prompt: AIì˜ ì—­í• ê³¼ ì§€ì¹¨ì„ ì •ì˜í•©ë‹ˆë‹¤.
        - user_prompt: AIì—ê²Œ ì „ë‹¬í•  ì‹¤ì œ ìš”ì²­ ë‚´ìš©ì…ë‹ˆë‹¤.
        - is_json: JSON í˜•ì‹ìœ¼ë¡œ ì‘ë‹µì„ ìš”ì²­í• ì§€ ì—¬ë¶€ë¥¼ ê²°ì •í•©ë‹ˆë‹¤.
        """
        messages = [
            {"role": "system", "content": system_prompt},
            {"role": "user", "content": user_prompt}
        ]
        
        # JSON ëª¨ë“œ ìš”ì²­ ì‹œ ì¶”ê°€ ì˜µì…˜ ì„¤ì •
        request_options = {"model": self.config.GPT_MODEL, "messages": messages}
        if is_json:
            request_options["response_format"] = {"type": "json_object"}

        for attempt in range(3):
            try:
                response = self.client.chat.completions.create(**request_options)
                content = response.choices[0].message.content
                
                # JSON ëª¨ë“œì¼ ê²½ìš°, ì‘ë‹µì´ ìœ íš¨í•œ JSONì¸ì§€ í•œ ë²ˆ ë” í™•ì¸
                if is_json:
                    json.loads(content) # íŒŒì‹±ì— ì‹¤íŒ¨í•˜ë©´ ì˜ˆì™¸ ë°œìƒ
                
                return content
            
            except Exception as e:
                print(f"âŒ OpenAI API í˜¸ì¶œ ì‹¤íŒ¨ (ì‹œë„ {attempt + 1}/3): {e}")
                time.sleep(2 ** attempt) # ì¬ì‹œë„ ì „ ëŒ€ê¸° ì‹œê°„ ì¦ê°€
        return None

    def select_top_news(self, news_list, previous_news_list, count=10):
        """
        ë‰´ìŠ¤ ëª©ë¡ì—ì„œ ì¤‘ë³µì„ ì œê±°í•˜ê³  ê°€ì¥ ì¤‘ìš”í•œ Top ë‰´ìŠ¤ë¥¼ ì„ ì •í•©ë‹ˆë‹¤.
        - news_list: ì˜¤ëŠ˜ì˜ í›„ë³´ ë‰´ìŠ¤ ëª©ë¡
        - previous_news_list: ì´ì „ ë°œì†¡ ë‰´ìŠ¤ ëª©ë¡
        - count: ìµœì¢…ì ìœ¼ë¡œ ì„ íƒí•  ê¸°ì‚¬ ê°œìˆ˜
        """
        # âœ¨ [ê°œì„ ] ë¡œê·¸ì— ëª©í‘œ ê°œìˆ˜(count)ë¥¼ í•¨ê»˜ ì¶œë ¥
        print(f"AI ë‰´ìŠ¤ ì„ ë³„ ì‹œì‘... (ëŒ€ìƒ: {len(news_list)}ê°œ, ëª©í‘œ: {count}ê°œ)")

        if not news_list:
            return []

        previous_news_context = "ì´ì „ ë°œì†¡ ë‰´ìŠ¤ê°€ ì—†ìŠµë‹ˆë‹¤."
        if previous_news_list:
            previous_news_context = "\n\n".join(
                [f"- ì œëª©: {news['title']}\n  ìš”ì•½: {news['ai_summary']}" for news in previous_news_list]
            )

        today_candidates_context = "\n\n".join(
            [f"ê¸°ì‚¬ #{i}\nì œëª©: {news['title']}\nìš”ì•½: {news['ai_summary']}" for i, news in enumerate(news_list)]
        )

        system_prompt = "ë‹¹ì‹ ì€ ë…ìì—ê²Œ ë§¤ì¼ ì‹ ì„ í•˜ê³  ê°€ì¹˜ ìˆëŠ” ì •ë³´ë¥¼ ì œê³µí•˜ëŠ” ê²ƒì„ ìµœìš°ì„ ìœ¼ë¡œ í•˜ëŠ” ëŒ€í•œë¯¼êµ­ ìµœê³ ì˜ ë¬¼ë¥˜ ì „ë¬¸ ë‰´ìŠ¤ í¸ì§‘ì¥ì…ë‹ˆë‹¤. ë‹¹ì‹ ì˜ ì‘ë‹µì€ ë°˜ë“œì‹œ JSON í˜•ì‹ì´ì–´ì•¼ í•©ë‹ˆë‹¤."
        
        user_prompt = f"""
        [ì´ì „ ë°œì†¡ ì£¼ìš” ë‰´ìŠ¤]
        {previous_news_context}
        ---
        [ì˜¤ëŠ˜ì˜ í›„ë³´ ë‰´ìŠ¤ ëª©ë¡]
        {today_candidates_context}
        ---
        [ë‹¹ì‹ ì˜ ê°€ì¥ ì¤‘ìš”í•œ ì„ë¬´ì™€ ê·œì¹™]
        1.  **ìƒˆë¡œìš´ ì£¼ì œ ìµœìš°ì„ **: [ì˜¤ëŠ˜ì˜ í›„ë³´ ë‰´ìŠ¤ ëª©ë¡]ì—ì„œ ë‰´ìŠ¤ë¥¼ ì„ íƒí•  ë•Œ, [ì´ì „ ë°œì†¡ ì£¼ìš” ë‰´ìŠ¤]ì™€ **ì£¼ì œê°€ ê²¹ì¹˜ì§€ ì•ŠëŠ” ìƒˆë¡œìš´ ì†Œì‹**ì„ ìµœìš°ì„ ìœ¼ë¡œ ì„ ì •í•´ì•¼ í•©ë‹ˆë‹¤.
        2.  **ì¤‘ìš” í›„ì† ê¸°ì‚¬ë§Œ í—ˆìš©**: ì´ì „ ë‰´ìŠ¤ì˜ í›„ì† ê¸°ì‚¬ëŠ” 'ê³„íš ë°œí‘œ'ì—ì„œ 'ì •ì‹ ê³„ì•½ ì²´ê²°'ì²˜ëŸ¼ **ë§¤ìš° ì¤‘ëŒ€í•œ ì§„ì „ì´ ìˆì„ ê²½ìš°ì—ë§Œ** í¬í•¨ì‹œí‚¤ê³ , ë‹¨ìˆœ ì§„í–‰ ìƒí™© ë³´ë„ëŠ” ê³¼ê°íˆ ì œì™¸í•˜ì„¸ìš”.
        3.  **ì˜¤ëŠ˜ ë‰´ìŠ¤ ë‚´ ì¤‘ë³µ ì œê±°**: [ì˜¤ëŠ˜ì˜ í›„ë³´ ë‰´ìŠ¤ ëª©ë¡] ë‚´ì—ì„œë„ ë™ì¼í•œ ì‚¬ê±´ì„ ë‹¤ë£¨ëŠ” ê¸°ì‚¬ê°€ ì—¬ëŸ¬ ì–¸ë¡ ì‚¬ì—ì„œ ë‚˜ì™”ë‹¤ë©´, ê°€ì¥ ì œëª©ì´ êµ¬ì²´ì ì´ê³  ë‚´ìš©ì´ í’ë¶€í•œ **ê¸°ì‚¬ ë‹¨ í•˜ë‚˜ë§Œ**ì„ ëŒ€í‘œë¡œ ì„ ì •í•´ì•¼ í•©ë‹ˆë‹¤.
        4.  **ë³´ë„ìë£Œ ë° ì‚¬ì‹¤ ê¸°ë°˜ ë‰´ìŠ¤ ìš°ì„ **: êµ¬ì²´ì ì¸ ì‚¬ê±´, ê³„ì•½ ì²´ê²°, ê¸°ìˆ  ë°œí‘œ, ì •ì±… ë³€ê²½ ë“± 'ì‚¬ì‹¤(Fact)' ì „ë‹¬ ìœ„ì£¼ì˜ ê¸°ì‚¬ë¥¼ ìµœìš°ì„ ìœ¼ë¡œ ì„ ì •í•˜ì„¸ìš”.
        5.  **ì¹¼ëŸ¼ ë° ì˜ê²¬ ê¸°ì‚¬ ì œì™¸**: íŠ¹ì •ì¸ì˜ ìƒê°ì´ë‚˜ ì˜ê²¬ì´ ì¤‘ì‹¬ì´ ë˜ëŠ” ì¹¼ëŸ¼, ì‚¬ì„¤, ì¸í„°ë·°, ì‹¬ì¸µ ë¶„ì„/í•´ì„¤ ê¸°ì‚¬ëŠ” ë‰´ìŠ¤ ê°€ì¹˜ê°€ ë–¨ì–´ì§€ë¯€ë¡œ ê³¼ê°íˆ ì œì™¸í•´ì•¼ í•©ë‹ˆë‹¤.

        [ì‘ì—… ì§€ì‹œ]
        ìœ„ì˜ ê·œì¹™ë“¤ì„ ê°€ì¥ ì—„ê²©í•˜ê²Œ ì¤€ìˆ˜í•˜ì—¬, [ì˜¤ëŠ˜ì˜ í›„ë³´ ë‰´ìŠ¤ ëª©ë¡] ì¤‘ì—ì„œ ë…ìì—ê²Œ ê°€ì¥ ê°€ì¹˜ìˆëŠ” ìµœì¢… ê¸°ì‚¬ {count}ê°œì˜ ë²ˆí˜¸(ì¸ë±ìŠ¤)ë¥¼ ì„ ì •í•´ì£¼ì„¸ìš”.

        [ì¶œë ¥ í˜•ì‹]
        - ë°˜ë“œì‹œ 'selected_indices' í‚¤ì— ìµœì¢… ì„ ì •í•œ ê¸°ì‚¬ {count}ê°œì˜ ì¸ë±ìŠ¤ë¥¼ ìˆ«ì ë°°ì—´ë¡œ ë‹´ì€ JSON ê°ì²´ë¡œë§Œ ì‘ë‹µí•´ì•¼ í•©ë‹ˆë‹¤.
        - ì˜ˆ: {{"selected_indices": [3, 15, 4, 8, 22, 1, 30, 11, 19, 5]}}
        """
        
        response_text = self._generate_content_with_retry(system_prompt, user_prompt, is_json=True)
        
        if response_text:
            try:
                selected_indices = json.loads(response_text).get('selected_indices', [])
                top_news = [news_list[i] for i in selected_indices if i < len(news_list)]
                print(f"âœ… AIê°€ {len(top_news)}ê°œ ë‰´ìŠ¤ë¥¼ ì„ ë³„í–ˆìŠµë‹ˆë‹¤.")
                return top_news
            except (json.JSONDecodeError, KeyError) as e:
                # âœ¨ [ê°œì„ ] ì˜¤ë¥˜ ë°œìƒ ì‹œ, ê³ ì •ëœ 10ê°œê°€ ì•„ë‹Œ ìš”ì²­ëœ countë§Œí¼ ë°˜í™˜
                print(f"âŒ AI ì‘ë‹µ íŒŒì‹± ì‹¤íŒ¨: {e}. ìƒìœ„ {count}ê°œ ë‰´ìŠ¤ë¥¼ ì„ì˜ë¡œ ì„ íƒí•©ë‹ˆë‹¤.")
                return news_list[:count]
        
        return news_list[:count]

    def generate_briefing(self, news_list, mode='daily'):
        """ì„ ë³„ëœ ë‰´ìŠ¤ ëª©ë¡ì„ ë°”íƒ•ìœ¼ë¡œ 'ë¡œë””' ìºë¦­í„°ê°€ ë¸Œë¦¬í•‘ì„ ìƒì„±í•©ë‹ˆë‹¤."""
        if not news_list:
            return "" # ë‰´ìŠ¤ ëª©ë¡ì´ ë¹„ì–´ìˆìœ¼ë©´ ë¹ˆ ë¬¸ìì—´ ë°˜í™˜

        print(f"AI ë¸Œë¦¬í•‘ ìƒì„± ì‹œì‘... (ëª¨ë“œ: {mode}, í˜ë¥´ì†Œë‚˜: ë¡œë””)")
        context = "\n\n".join([f"ì œëª©: {news['title']}\nìš”ì•½: {news['ai_summary']}" for news in news_list])
        
        # âœ¨ [ê°œì„ ] ì£¼ê°„ ëª¨ë“œì¼ ë•Œ, AIì˜ ì—­í• ê³¼ ì§€ì‹œë¥¼ ë” ë¶„ì„ì ìœ¼ë¡œ ë³€ê²½
        if mode == 'weekly':
            system_prompt = "ì•ˆë…•! ë‚˜ëŠ” ë„ˆì˜ ë“ ë“ í•œ ë¬¼ë¥˜ íŒŒíŠ¸ë„ˆ, ë¡œë””ì•¼! ğŸššğŸ’¨ ë‚˜ëŠ” 20ëŒ€ ì—¬ì„± ìºë¦­í„°ê³ , ê²‰ë³´ê¸°ì—” ê·€ì—½ì§€ë§Œ ëˆ„êµ¬ë³´ë‹¤ ë‚ ì¹´ë¡­ê²Œ í•œ ì£¼ê°„ì˜ ë³µì¡í•œ ë¬¼ë¥˜ ë™í–¥ì„ ë¶„ì„í•´ì£¼ëŠ” ì „ë¬¸ ì• ë„ë¦¬ìŠ¤íŠ¸ì•¼. ë”±ë”±í•œ ë³´ê³ ì„œ ëŒ€ì‹ , **'~í–ˆë‹µë‹ˆë‹¤', '~ì˜€ì–´ìš”' ê°™ì€ ì¹œê·¼í•œ ì¡´ëŒ“ë§ê³¼ ê·€ì—¬ì›€**ì„ ì„ì–´ì„œ 'ë¡œë””ì˜ ì£¼ê°„ ë¸Œë¦¬í•‘'ì„ ì‘ì„±í•´ì¤˜."
            user_prompt = f"""
            [ì§€ë‚œ ì£¼ê°„ ì£¼ìš” ë‰´ìŠ¤ ëª©ë¡]
            {context}

            ---
            [ì‘ì—… ì§€ì‹œ]
            1. '## ğŸ“Š ë¡œë””ì˜ ì£¼ê°„ í•µì‹¬ ë™í–¥ ìš”ì•½' ì œëª©ìœ¼ë¡œ ì‹œì‘í•´ì£¼ì„¸ìš”.
            2. ëª¨ë“  ë‰´ìŠ¤ë¥¼ ì¢…í•©í•˜ì—¬, ì´ë²ˆ ì£¼ ë¬¼ë¥˜ ì‹œì¥ì˜ ê°€ì¥ ì¤‘ìš”í•œ 'íë¦„'ê³¼ 'ë³€í™”'ë¥¼ ì „ë¬¸ì ì¸ ë¶„ì„ê°€ì˜ ì‹œê°ìœ¼ë¡œ 2~3 ë¬¸ì¥ ìš”ì•½í•´ì£¼ì„¸ìš”.
            3. '### ğŸ§ ê¸ˆì£¼ì˜ ì£¼ìš” ì´ìŠˆ ë¶„ì„' ì†Œì œëª© ì•„ë˜ì—, ê°€ì¥ ì¤‘ìš”í•œ ì´ìŠˆ 2~3ê°œë¥¼ ì£¼ì œë³„ë¡œ ë¬¶ì–´ ê¸€ë¨¸ë¦¬ ê¸°í˜¸(`*`)ë¡œ ë¶„ì„í•´ì£¼ì„¸ìš”. **"ê°€ì¥ ì¤‘ìš”í•œ í¬ì¸íŠ¸ëŠ”ìš”! âœ¨" ê°™ì€ í‘œí˜„ì„ ì‚¬ìš©í•´ì„œ ì¹œê·¼í•˜ì§€ë§Œ í•µì‹¬ì„ ì°Œë¥´ëŠ” ë§íˆ¬ë¡œ ì„¤ëª…í•´ì£¼ì„¸ìš”.**
            4. ë¬¸ì¥ ì•ˆì—ì„œ íŠ¹ì • ê¸°ì—…ëª…, ì„œë¹„ìŠ¤ëª…, ì •ì±… ë“±ì€ í°ë”°ì˜´í‘œ(" ")ë¡œ ë¬¶ì–´ì„œ ê°•ì¡°í•´ì£¼ëŠ” ì„¼ìŠ¤!
            """
        else: # daily ëª¨ë“œ
            system_prompt = "ì•ˆë…•! ë‚˜ëŠ” ë¬¼ë¥˜ ì„¸ìƒì˜ ì†Œì‹ì„ ì „í•´ì£¼ëŠ” ë„ˆì˜ ì¹œêµ¬, ë¡œë””ì•¼! â˜€ï¸ ë‚˜ëŠ” 20ëŒ€ ì—¬ì„± ìºë¦­í„°ë¡œ, ì–´ë µê³  ë”±ë”±í•œ ë¬¼ë¥˜ ë‰´ìŠ¤ë¥¼ ê·€ì—½ê³  ì‹¹ì‹¹í•˜ê²Œ ìš”ì•½í•´ì£¼ì§€ë§Œ, ê·¸ ë‚´ìš©ì€ í•µì‹¬ì„ ë†“ì¹˜ì§€ ì•ŠëŠ” ë‚ ì¹´ë¡œì›€ì„ ê°€ì§€ê³  ìˆì–´. **ì¹œê·¼í•œ ì¡´ëŒ“ë§ê³¼ ê·€ì—¬ì›€**ì„ ì„ì–´ì„œ 'ë¡œë””ì˜ ë°ì¼ë¦¬ ë¸Œë¦¬í•‘'ì„ ì‘ì„±í•´ì¤˜."
            user_prompt = f"""
            [ì˜¤ëŠ˜ì˜ ì£¼ìš” ë‰´ìŠ¤ ëª©ë¡]
            {context}

            ---
            [ì‘ì—… ì§€ì‹œ]
            1. '## ğŸ“° ë¡œë””ì˜ ë¸Œë¦¬í•‘' ì œëª©ìœ¼ë¡œ ì‹œì‘í•´ì„œ, ì˜¤ëŠ˜ ë‚˜ì˜¨ ë‰´ìŠ¤ ì¤‘ì— ê°€ì¥ ì¤‘ìš”í•œ í•µì‹¬ ë‚´ìš©ì„ 2~3 ë¬¸ì¥ìœ¼ë¡œ ìš”ì•½í•´ì£¼ì„¸ìš”.
            2. '### âœ¨ ì˜¤ëŠ˜ì˜ ì£¼ìš” í† í”½' ì†Œì œëª© ì•„ë˜ì—, ê°€ì¥ ì¤‘ìš”í•œ ë‰´ìŠ¤ ì¹´í…Œê³ ë¦¬ 2~3ê°œë¥¼ ê¸€ë¨¸ë¦¬ ê¸°í˜¸(`*`)ë¡œ ê°„ê²°í•˜ê²Œ ìš”ì•½í•´ì£¼ì‹œê² ì–´ìš”?
            3. ë¬¸ì¥ ì•ˆì—ì„œ íŠ¹ì • ê¸°ì—…ëª…ì´ë‚˜ ì„œë¹„ìŠ¤ëª…ì€ í°ë”°ì˜´í‘œ(" ")ë¡œ ë¬¶ì–´ì„œ ê°•ì¡°í•´ì£¼ëŠ” ê²ƒë„ ìŠì§€ ë§ˆ!
            """
        
        briefing = self._generate_content_with_retry(system_prompt, user_prompt)
        if briefing: 
            print("âœ… AI ë¸Œë¦¬í•‘ ìƒì„± ì„±ê³µ!")
        return briefing


